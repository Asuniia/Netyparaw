"use strict";var e=require("node-html-parser"),t=require("date-fns"),r=require("date-fns/locale");function n(e){return e&&e.__esModule?e:{default:e}}var s=n(e),o=class{url;method="GET";headers;body;redirect;constructor(e,t,r="manual"){this.url=new URL(e+t),this.headers=new Headers,this.redirect=r}setFormData(e){this.method="POST",this.body=e,this.headers.set("Content-Type","application/x-www-form-urlencoded")}setSession(e){const t=[`SERVERID=${e.serverId}`,`${e.cookieName}=${e.id}`];this.headers.set("Cookie",t.join("; "))}async send(){return this.headers.set("Accept-Encoding","gzip, deflate, br"),this.headers.set("Accept","text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8"),this.headers.set("User-Agent","Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3"),fetch(this.url,{method:this.method,headers:this.headers,body:this.body,redirect:this.redirect})}},i={login_token_csrf:/<input[^>]*name="token_csrf"[^>]*value="([^"]+)"/,check_instance_netypareo:/NetYPar/g,check_instance_ymag:/YMAG/g,student_timetable:/var planningJSON += (.+);/};function a(e){const t=e.get("set-cookie");if(!t)return[];return t.match(/(?:[^,]+?=[^;]+(?:;[^,]*)*)(?=, |$)/g)?.map(e=>e.trim())||[]}var l=e=>({web_class:e.classe,text:e.libelle}),c=e=>{let t=e.couleur;if(t.startsWith("rgba")){const r=e.color.slice(5,-1).split(", "),n=parseInt(r[0]),s=parseInt(r[1]),o=parseInt(r[2]),i=parseInt(r[3]);t=`#${n.toString(16)}${s.toString(16)}${o.toString(16)}${i.toString(16)}`}const r=e.minuteDebut,n=Math.floor(r/60),s=new Date(0,0,0,n,r%60),o=e.minuteDebut+e.duree,i=Math.floor(o/60),a=new Date(0,0,0,i,o%60),c=e.icones.map(l);return{id:e.code,type:e.type,name:e.libelle,duration:e.duree,details:e.detail,subject_id:e.metadatas.codeMatiere,subject_coefficient:e.metadatas.coeff,subject_groups:e.metadatas.codesGroupes,color:t,start:s,end:a,icon:c}},d=e=>{const n=e.querySelector(".block-toolbar .ellipsis")?.textContent?.trim()??"",s=n.replace(/^(M\.|Mme)\s*/i,"").trim(),[o,...i]=s.split(/\s+/),a=i.join(" "),l=`${a} ${o}`.trim(),c=n.includes("Mme")?"F":n.includes("M.")?"M":"O",d=e.querySelector("div[id^='card-adresse']"),u=(Array.from(d?.querySelectorAll(".block-adresse-ligne")??[]).filter(e=>e.textContent.includes("Adresse")).map(e=>e.textContent.trim()).join("\n").split("\n").map(e=>e.trim()).filter(e=>e&&"-"!==e&&!/\d{5}\s+\S+/.test(e)&&!/^[A-Z\s\-]{2,}$/.test(e))??[]).join(", "),h=d?.querySelector(".block-body")?.textContent.split("\n").map(e=>e.trim()).filter(Boolean)??[],p=h.find(e=>/\d{5}\s+\S+/.test(e))||"",f=p.match(/\d{5}/)?.[0]??"",m=p.replace(f,"").trim(),w=h.find(e=>/^[A-Z\s\-]{2,}$/.test(e))||"France",g=d?.querySelector("a[href^='tel:']")?.textContent.replace(/[\s.]/g,"").trim()??"",y=d?.querySelector("a[href^='/cdn-cgi/l/email-protection'], a[href^='mailto:']"),S=y?.getAttribute("href"),b=S?.startsWith("/cdn-cgi/")?(e=>{const t=e.startsWith("#")?e.slice(1):e;let r="";const n=parseInt(t.slice(0,2),16);for(let e=2;e<t.length;e+=2){const s=parseInt(t.slice(e,e+2),16)^n;r+=String.fromCharCode(s)}return r})(S.split("#")[1]||""):y?.textContent.trim()??"",k=e.querySelector("p")?.textContent.includes("NÃ©")?e.querySelector("p")?.textContent??"":"",E=k.match(/le (\d{1,2} \w+ \d{4})/)?.[1]||"",_=t.parse(E,"d MMMM yyyy",new Date,{locale:r.fr}),x=e.querySelector(".modal-link-formation")?.textContent.trim()??"",F=e.querySelector(".lnk-modal-groupe")?.textContent.trim()??"",$=(e.querySelector(".user-info-label span")?.textContent.trim()??"").match(/(\d{4}-\d{4})/),v=$?$[1]:null;return{firstName:a,lastName:o,fullName:l,email:b,phone:g,address:u,postalCode:f,city:m,country:w,gender:c,dateOfBirth:t.format(_,"yyyy-MM-dd"),className:x,groupName:F,currentSchoolCycle:v}};exports.getProfile=async t=>{if(!t.id)throw new Error("Session cookie is not defined ! You must login first.");if(!t.baseURL)throw new Error("Base URL is not defined ! You must login first.");const r=new o(t.baseURL,"/apprenant/details");r.setSession(t),console.log("reqqq",r);const n=await r.send();if(console.log("status",n.status),200!==n.status)throw new Error("Failed to fetch profile: The session has expired");const s=await n.arrayBuffer(),i=Buffer.from(s).toString("latin1");try{const t=e.parse(i);return d(t)}catch(e){throw new Error(`Failed to parse the profile: ${e}`)}},exports.loginCookie=async(e,t,r)=>{const n=new o(e,"/"),s=await n.send(),a=await s.text();if(302!==s.status){if(!i.check_instance_netypareo.test(a))throw new Error("Failed to verify instance. Not a valid NetYPareo instance");if(!i.check_instance_ymag.test(a))throw new Error("Failed to verify instance. Not a valid NetYPareo instance")}const l=s.headers.get("location")||"",c={id:t,baseURL:`${e}${l?l.split(".")[1]+".php":""}`,serverId:r,cookieName:"NYSESSID"},d=new o(c.baseURL,"/apprenant/accueil");d.setSession(c);const u=await d.send();if(200!==u.status)throw new Error("Failed to login: Server respond with "+u.status);return c},exports.loginCredentials=async(e,t,r,n="NYSESSID")=>{const l=new o(e,"/"),c=await l.send(),d=await c.text();if(302!==c.status){if(!i.check_instance_netypareo.test(d))throw new Error("Failed to verify instance. Not a valid NetYPareo instance netypareo");if(!i.check_instance_ymag.test(d))throw new Error("Failed to verify instance. Not a valid NetYPareo instance ymag")}const u=c.headers.get("location")||"",h=new o(e,`/${u}/login/`),p=await h.send(),f=a(p.headers),m=f.find(e=>e.startsWith(`${n}=`));if(!m)throw new Error("Failed to get CSRF token cookie");let w=f.find(e=>e.startsWith("SERVERID="))??"SERVERID=local";if(console.log("Server ID cookie:",w),void 0===w)throw new Error("Failed to get SERVERID cookie");const g=await p.text(),y=g.match(i.login_token_csrf);if(!y)throw new Error("Failed to get CSRF token");const S=y[1],b=s.default(g),k=b.querySelector("form")?.getAttribute("action");if(!k)throw new Error("Failed to get form URL");const E=new URLSearchParams;E.append("login",t),E.append("password",r),E.append("screenWidth","1680"),E.append("screenHeight","1050"),E.append("token_csrf",S),E.append("btnSeConnecter","Se%20connecter");const _=new o(e.endsWith("index.php")?e.slice(0,-10):e,`/${k}`);_.setFormData(E.toString()),_.headers.set("Cookie",`${m}; ${w}`);const x=await _.send(),F=a(x.headers);if(![200,303].includes(x.status))throw new Error("Failed to login: Server respond with "+x.status);if(303===x.status&&x.headers.get("location")?.includes("8"))throw new Error("Failed to login: Connection refused.");if(303===x.status&&!x.headers.get("location"))throw new Error("Failed to login: No location header found.");if(303===x.status&&!F.find(e=>e.startsWith(`${n}=`)))throw new Error("Failed to login: No session cookie found.");if(303===x.status&&x.headers.get("location")?.includes("2"))throw new Error("Failed to login: Invalid credentials.");if(303===x.status&&x.headers.get("location")?.includes("4"))throw new Error("Failed to login: Account locked or not activated.");const $={id:F.find(e=>e.startsWith(`${n}=`)).split("=")[1].split(";")[0],baseURL:`${e}${u?u.split(".")[1]+".php":""}`,serverId:w.split("=")[1],cookieName:m.split("=")[0]};return console.log("sess",$),$},exports.planningFromDay=async(e,t)=>{if(!e.id)throw new Error("Session cookie is not defined ! You must login first.");if(!e.baseURL)throw new Error("Base URL is not defined ! You must login first.");const r=t.toISOString().split("T")[0].split("-").reverse().join("/"),n=new o(e.baseURL,`/planning/jour/ajax/${r}`);n.setSession(e);const s=await n.send();if(200!==s.status)throw new Error("Failed to fetch planning: The session has expired");try{const e=await s.text(),t=JSON.parse(e);return{day_start_in_minutes:(i=t).configuration.minuteDebut,day_end_in_minutes:i.configuration.minuteFin,day_number:i.configuration.jours[0],week_id:i.semaines[0].code,week_start:new Date(i.semaines[0].dateDebut),week_text:i.semaines[0].libelle,slots:i.semaines[0].ressources[0].seances.map(c)}}catch(e){throw new Error(`Failed to parse the planning: ${e}`)}var i},exports.planningFromWeek=async(e,t,r)=>{if(!e.id)throw new Error("Session cookie is not defined ! You must login first.");if(!e.baseURL)throw new Error("Base URL is not defined ! You must login first.");const n=new o(e.baseURL,`/apprenant/planning/courant/?semaineDebut=${t}${r}`);n.setSession(e);const s=await n.send();if(200!==s.status)throw new Error("Failed to fetch timetable: The session has expired");try{const e=(await s.text()).match(i.student_timetable);if(!e)throw new Error("Failed to get student timetable");const t=JSON.parse(e[1]);return console.log("planning",t),{week_id:(a=t).semaines[0].code,week_start:new Date(a.semaines[0].dateDebut),week_text:a.semaines[0].libelle,slots:a.semaines[0].ressources[0].seances.map(c)}}catch(e){throw new Error(`Failed to parse the planning: ${e}`)}var a};//# sourceMappingURL=index.js.map