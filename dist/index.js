"use strict";var e=require("cheerio"),t=require("date-fns"),r=require("date-fns/locale"),n=require("node-html-parser");function o(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,Object.freeze(t)}var i=o(e),a=class{url;method="GET";headers;body;redirect;constructor(e,t,r="manual"){this.url=new URL(e+t),this.headers=new Headers,this.redirect=r}setFormData(e){this.method="POST",this.body=e,this.headers.set("Content-Type","application/x-www-form-urlencoded")}setSession(e){const t=[`SERVERID=${e.serverId}`,`${e.cookieName}=${e.id}`];this.headers.set("Cookie",t.join("; "))}async send(){return this.headers.set("Accept-Encoding","gzip, deflate, br"),this.headers.set("Accept","text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8"),this.headers.set("User-Agent","Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3"),fetch(this.url,{method:this.method,headers:this.headers,body:this.body,redirect:this.redirect})}},s={login_token_csrf:/<input[^>]*name="token_csrf"[^>]*value="([^"]+)"/,check_instance_netypareo:/NetYPar/g,check_instance_ymag:/YMAG/g,student_timetable:/var planningJSON += (.+);/};function c(e){const t=e.get("set-cookie");if(!t)return[];return t.match(/(?:[^,]+?=[^;]+(?:;[^,]*)*)(?=, |$)/g)?.map(e=>e.trim())||[]}var l=e=>({web_class:e.classe,text:e.libelle}),d=e=>{let t=e.couleur;if(t.startsWith("rgba")){const r=e.color.slice(5,-1).split(", "),n=parseInt(r[0]),o=parseInt(r[1]),i=parseInt(r[2]),a=parseInt(r[3]);t=`#${n.toString(16)}${o.toString(16)}${i.toString(16)}${a.toString(16)}`}const r=e.minuteDebut,n=Math.floor(r/60),o=new Date(0,0,0,n,r%60),i=e.minuteDebut+e.duree,a=Math.floor(i/60),s=new Date(0,0,0,a,i%60),c=e.icones.map(l);return{id:e.code,type:e.type,name:e.libelle,duration:e.duree,details:e.detail,subject_id:e.metadatas.codeMatiere,subject_coefficient:e.metadatas.coeff,subject_groups:e.metadatas.codesGroupes,color:t,start:o,end:s,icon:c}},p=e=>{const t=[];return e.find("tr").each((e,r)=>{const n=(e=>{const t=e("td > span"),r=e("td.coeff"),n=e("td.moyenne-grp"),o=e("td.moyenne-mini-grp"),i=e("td.moyenne-maxi-grp"),a=e("td.moyenneApp"),s=e("td.cell-appreciation"),c=t.text().trim(),l=parseFloat(r.text().replace(",",".")),d=""==n.text().trim()?void 0:parseFloat(n.text().replace(",",".")),p=""==o.text().trim()?void 0:parseFloat(o.text().replace(",",".")),u=""==i.text().trim()?void 0:parseFloat(i.text().replace(",",".")),m=""==a.text().trim()?void 0:parseFloat(a.text().replace(",",".")),f=""==s.text().trim()?void 0:s.text().trim(),h=parseInt(s.attr("data-code_inscription")??"-1"),g=parseInt(s.attr("data-code_apprenant")??"-1");return{subject_id:parseInt(s.attr("data-code_matiere")??"-1"),subject_name:c,coefficient:l,group_average:d,group_average_min:p,group_average_max:u,average:m,teacher_comment:f,registration_id:h,student_id:g}})(i.load(r));t.push(n)}),t},u=(e,t)=>{let r={};return t.forEach(t=>{r[t.session_id]=((e,t)=>{const r=e(`div[id="bulletin_${t.session_id}"]`).find("table"),n=r.find("tbody"),o=r.find("tfoot"),i=p(e(n)),a=o.find("td.moyenne-grp"),s=o.find("td.moyenne-mini-grp"),c=o.find("td.moyenne-maxi-grp"),l=o.find("td.moyenneApp"),d=o.find("td.cell-appreciation");return{subject_list:i,group_average:""==a.text().trim()?void 0:parseFloat(a.text().replace(",",".")),group_average_min:""==s.text().trim()?void 0:parseFloat(s.text().replace(",",".")),group_average_max:""==c.text().trim()?void 0:parseFloat(c.text().replace(",",".")),average:""==l.text().trim()?void 0:parseFloat(l.text().replace(",",".")),teacher_comment:""==d.text().trim()?void 0:d.text().trim(),registration_id:parseInt(d.attr("data-code_inscription")??"-1"),student_id:parseInt(d.attr("data-code_apprenant")??"-1")}})(e,t)}),r},m=e=>{const t=(e=>{const t=e("select[id='bulletin-filtre-periode']");if(0===t.length)return[];const r=t.find("option");if(0===r.length)return[];const n=[];return r.each((t,r)=>{const o=parseInt(e(r).attr("value")??"-1"),i=parseInt(e(r).attr("data-code-session")??"-1"),a=e(r).text();n.push({session_id:o,session_code:i,name:a})}),n})(e);return{session_list:t,session:u(e,t)}},f=e=>{const t=e('table[id^="tableau-note-"] > tbody');if(0===t.length)return[];const r=t.find("tr");if(0===r.length)return[];const n=[];return r.each((e,t)=>{const r=(e=>{const t=e("td").first(),r=t.find("span"),n=e("td").eq(1),o=e("td").eq(2),i=e("td").eq(3),a=e("td").eq(4),s=r.text().trim(),c=r.attr("data-tooltip-content")??"",l=new Date(t.text().trim().slice(-10)),d=n.text().trim(),p=o.text().trim(),u=parseFloat(i.text().replace(",",".")),m=parseFloat(a.text().trim().replace(",","."))||void 0,f=!/^\d+\.\d+$/.test(a.text().trim().replace(",","."));return{teacher_name:c,teacher_initials:s,grade_type:d,date:l,name:p,coefficient:u,grade:m,absent:f,absence_reason:f?a.text().trim():void 0}})(i.load(t));n.push(r)}),n},h=e=>{const n=e.querySelector(".block-toolbar .ellipsis")?.textContent?.trim()??"",o=n.replace(/^(M\.|Mme)\s*/i,"").trim(),[i,...a]=o.split(/\s+/),s=a.join(" "),c=`${s} ${i}`.trim(),l=n.includes("Mme")?"F":n.includes("M.")?"M":"O",d=e.querySelector("div[id^='card-adresse']"),p=(Array.from(d?.querySelectorAll(".block-adresse-ligne")??[]).filter(e=>e.textContent.includes("Adresse")).map(e=>e.textContent.trim()).join("\n").split("\n").map(e=>e.trim()).filter(e=>e&&"-"!==e&&!/\d{5}\s+\S+/.test(e)&&!/^[A-Z\s\-]{2,}$/.test(e))??[]).join(", "),u=d?.querySelector(".block-body")?.textContent.split("\n").map(e=>e.trim()).filter(Boolean)??[],m=u.find(e=>/\d{5}\s+\S+/.test(e))||"",f=m.match(/\d{5}/)?.[0]??"",h=m.replace(f,"").trim(),g=u.find(e=>/^[A-Z\s\-]{2,}$/.test(e))||"France",w=d?.querySelector("a[href^='tel:']")?.textContent.replace(/[\s.]/g,"").trim()??"",x=d?.querySelector("a[href^='/cdn-cgi/l/email-protection'], a[href^='mailto:']"),_=x?.getAttribute("href"),b=_?.startsWith("/cdn-cgi/")?(e=>{const t=e.startsWith("#")?e.slice(1):e;let r="";const n=parseInt(t.slice(0,2),16);for(let e=2;e<t.length;e+=2){const o=parseInt(t.slice(e,e+2),16)^n;r+=String.fromCharCode(o)}return r})(_.split("#")[1]||""):x?.textContent.trim()??"",y=e.querySelector("p")?.textContent.includes("NÃ©")?e.querySelector("p")?.textContent??"":"",v=y.match(/le (\d{1,2} \w+ \d{4})/)?.[1]||"",S=t.parse(v,"d MMMM yyyy",new Date,{locale:r.fr}),F=e.querySelector(".modal-link-formation")?.textContent.trim()??"",E=e.querySelector(".lnk-modal-groupe")?.textContent.trim()??"",k=(e.querySelector(".user-info-label span")?.textContent.trim()??"").match(/(\d{4}-\d{4})/),$=k?k[1]:null;return{firstName:s,lastName:i,fullName:c,email:b,phone:w,address:p,postalCode:f,city:h,country:g,gender:l,dateOfBirth:t.format(S,"yyyy-MM-dd"),className:F,groupName:E,currentSchoolCycle:$}};exports.getProfile=async e=>{if(!e.id)throw new Error("Session cookie is not defined ! You must login first.");if(!e.baseURL)throw new Error("Base URL is not defined ! You must login first.");const t=new a(e.baseURL,"/apprenant/details");t.setSession(e),console.log("reqqq",t);const r=await t.send();if(console.log("status",r.status),200!==r.status)throw new Error("Failed to fetch profile: The session has expired");const o=await r.arrayBuffer(),i=Buffer.from(o).toString("latin1");try{const e=n.parse(i);return h(e)}catch(e){throw new Error(`Failed to parse the profile: ${e}`)}},exports.loginCookie=async(e,t,r)=>{const n=new a(e,"/"),o=await n.send(),i=await o.text();if(302!==o.status){if(!s.check_instance_netypareo.test(i))throw new Error("Failed to verify instance. Not a valid NetYPareo instance");if(!s.check_instance_ymag.test(i))throw new Error("Failed to verify instance. Not a valid NetYPareo instance")}const c=o.headers.get("location")||"",l={id:t,baseURL:`${e}${c?c.split(".")[1]+".php":""}`,serverId:r,cookieName:"NYSESSID"},d=new a(l.baseURL,"/apprenant/accueil");d.setSession(l);const p=await d.send();if(200!==p.status)throw new Error("Failed to login: Server respond with "+p.status);return l},exports.loginCredentials=async(e,t,r,n="NYSESSID")=>{const o=new a(e,"/"),l=await o.send(),d=await l.text();if(302!==l.status){if(!s.check_instance_netypareo.test(d))throw new Error("Failed to verify instance. Not a valid NetYPareo instance netypareo");if(!s.check_instance_ymag.test(d))throw new Error("Failed to verify instance. Not a valid NetYPareo instance ymag")}const p=l.headers.get("location")||"",u=new a(e,`/${p}/login/`),m=await u.send(),f=c(m.headers),h=f.find(e=>e.startsWith(`${n}=`));if(!h)throw new Error("Failed to get CSRF token cookie");let g=f.find(e=>e.startsWith("SERVERID="))??"SERVERID=local";if(console.log("Server ID cookie:",g),void 0===g)throw new Error("Failed to get SERVERID cookie");const w=await m.text(),x=w.match(s.login_token_csrf);if(!x)throw new Error("Failed to get CSRF token");const _=x[1],b=i.load(w)("form").attr("action");if(!b)throw new Error("Failed to get form URL");const y=new URLSearchParams;y.append("login",t),y.append("password",r),y.append("screenWidth","1680"),y.append("screenHeight","1050"),y.append("token_csrf",_),y.append("btnSeConnecter","Se%20connecter");const v=new a(e.endsWith("index.php")?e.slice(0,-10):e,`/${b}`);v.setFormData(y.toString()),v.headers.set("Cookie",`${h}; ${g}`);const S=await v.send(),F=c(S.headers);if(![200,303].includes(S.status))throw new Error("Failed to login: Server respond with "+S.status);if(303===S.status&&S.headers.get("location")?.includes("8"))throw new Error("Failed to login: Connection refused.");if(303===S.status&&!S.headers.get("location"))throw new Error("Failed to login: No location header found.");if(303===S.status&&!F.find(e=>e.startsWith(`${n}=`)))throw new Error("Failed to login: No session cookie found.");if(303===S.status&&S.headers.get("location")?.includes("2"))throw new Error("Failed to login: Invalid credentials.");if(303===S.status&&S.headers.get("location")?.includes("4"))throw new Error("Failed to login: Account locked or not activated.");const E={id:F.find(e=>e.startsWith(`${n}=`)).split("=")[1].split(";")[0],baseURL:`${e}${p?p.split(".")[1]+".php":""}`,serverId:g.split("=")[1],cookieName:h.split("=")[0]};return console.log("sess",E),E},exports.planningFromDay=async(e,t)=>{if(!e.id)throw new Error("Session cookie is not defined ! You must login first.");if(!e.baseURL)throw new Error("Base URL is not defined ! You must login first.");const r=t.toISOString().split("T")[0].split("-").reverse().join("/"),n=new a(e.baseURL,`/planning/jour/ajax/${r}`);n.setSession(e);const o=await n.send();if(200!==o.status)throw new Error("Failed to fetch planning: The session has expired");try{const e=await o.text(),t=JSON.parse(e);return{day_start_in_minutes:(i=t).configuration.minuteDebut,day_end_in_minutes:i.configuration.minuteFin,day_number:i.configuration.jours[0],week_id:i.semaines[0].code,week_start:new Date(i.semaines[0].dateDebut),week_text:i.semaines[0].libelle,slots:i.semaines[0].ressources[0].seances.map(d)}}catch(e){throw new Error(`Failed to parse the planning: ${e}`)}var i},exports.planningFromWeek=async(e,t,r)=>{if(!e.id)throw new Error("Session cookie is not defined ! You must login first.");if(!e.baseURL)throw new Error("Base URL is not defined ! You must login first.");const n=new a(e.baseURL,`/apprenant/planning/courant/?semaineDebut=${t}${r}`);n.setSession(e);const o=await n.send();if(200!==o.status)throw new Error("Failed to fetch timetable: The session has expired");try{const e=(await o.text()).match(s.student_timetable);if(!e)throw new Error("Failed to get student timetable");const t=JSON.parse(e[1]);return console.log("planning",t),{week_id:(i=t).semaines[0].code,week_start:new Date(i.semaines[0].dateDebut),week_text:i.semaines[0].libelle,slots:i.semaines[0].ressources[0].seances.map(d)}}catch(e){throw new Error(`Failed to parse the planning: ${e}`)}var i},exports.report=async e=>{if(!e.id)throw new Error("Session cookie is not defined ! You must login first.");if(!e.baseURL)throw new Error("Base URL is not defined ! You must login first.");const t=new a(e.baseURL,"/apprenant/bulletin");t.setSession(e);const r=await t.send();if(200!==r.status)throw new Error("Failed to fetch report: The session has expired");const n=await r.text(),o=i.load(n);return m(o)},exports.reportSubjectDetails=async(e,t,r)=>{if(!e.id||!e.baseURL)throw new Error("Session is not valid ! You must login first.");const n=new a(e.baseURL,`/apprenant/detail-notes/${t.registration_id}/${t.subject_id}/${r}`);n.setSession(e);const o=await n.send();if(200!==o.status)throw new Error("Failed to fetch subject details: The session has expired");const s=await o.text();return(e=>{const t=e('td.table-cell.text-bold:contains("Moyenne de l\'apprenant")').next(),r=e('td.table-cell.text-bold:contains("Moyenne du groupe")').next(),n=e('td.table-cell.text-bold:contains("Moyenne minimale")').next(),o=e('td.table-cell.text-bold:contains("Moyenne maximale")').next(),i=e('div.section-title:contains("ApprÃ©ciation")').next(),a=e("div.modal-tabs-description"),s=a.text().trim().split("\n")[0],c=parseFloat(a.text().trim().split("\n")[1].replace("- coef. ","").trim().replace(",",".")),l=f(e),d="-"==t.text().trim()?void 0:parseFloat(t.text().replace(",","."));return{subject_name:s,subject_coefficient:c,grades:l,group_average:"-"==r.text().trim()?void 0:parseFloat(r.text().replace(",",".")),group_average_min:"-"==n.text().trim()?void 0:parseFloat(n.text().replace(",",".")),group_average_max:"-"==o.text().trim()?void 0:parseFloat(o.text().replace(",",".")),average:d,teacher_comment:i.text().trim().includes("Les apprÃ©ciations ne sont pas consultables pour cette pÃ©riode.")?void 0:i.text().trim()}})(i.load(s))};//# sourceMappingURL=index.js.map