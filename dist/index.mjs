import*as e from"cheerio";import{parse as t,format as r}from"date-fns";import{fr as n}from"date-fns/locale";var i=class{url;method="GET";headers;body;redirect;constructor(e,t,r="manual"){this.url=new URL(e+t),this.headers=new Headers,this.redirect=r}setFormData(e){this.method="POST",this.body=e,this.headers.set("Content-Type","application/x-www-form-urlencoded")}setSession(e){const t=[`SERVERID=${e.serverId}`,`${e.cookieName}=${e.id}`];this.headers.set("Cookie",t.join("; "))}async send(){return this.headers.set("Accept-Encoding","gzip, deflate, br"),this.headers.set("Accept","text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8"),this.headers.set("User-Agent","Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3"),fetch(this.url,{method:this.method,headers:this.headers,body:this.body,redirect:this.redirect})}},a={login_token_csrf:/<input[^>]*name="token_csrf"[^>]*value="([^"]+)"/,check_instance_netypareo:/NetYPar/g,check_instance_ymag:/YMAG/g,student_timetable:/var planningJSON += (.+);/};function s(e){const t=e.get("set-cookie");if(!t)return[];return t.match(/(?:[^,]+?=[^;]+(?:;[^,]*)*)(?=, |$)/g)?.map(e=>e.trim())||[]}var o=async(t,r,n,o="NYSESSID")=>{const d=new i(t,"/"),c=await d.send(),l=await c.text();if(302!==c.status){if(!a.check_instance_netypareo.test(l))throw new Error("Failed to verify instance. Not a valid NetYPareo instance netypareo");if(!a.check_instance_ymag.test(l))throw new Error("Failed to verify instance. Not a valid NetYPareo instance ymag")}const p=c.headers.get("location")||"",m=new i(t,`/${p}/login/`),u=await m.send(),f=s(u.headers),h=f.find(e=>e.startsWith(`${o}=`));if(!h)throw new Error("Failed to get CSRF token cookie");let w=f.find(e=>e.startsWith("SERVERID="))??"SERVERID=local";if(console.log("Server ID cookie:",w),void 0===w)throw new Error("Failed to get SERVERID cookie");const g=await u.text(),x=g.match(a.login_token_csrf);if(!x)throw new Error("Failed to get CSRF token");const _=x[1],b=e.load(g)("form").attr("action");if(!b)throw new Error("Failed to get form URL");const v=new URLSearchParams;v.append("login",r),v.append("password",n),v.append("screenWidth","1680"),v.append("screenHeight","1050"),v.append("token_csrf",_),v.append("btnSeConnecter","Se%20connecter");const y=new i(t.endsWith("index.php")?t.slice(0,-10):t,`/${b}`);y.setFormData(v.toString()),y.headers.set("Cookie",`${h}; ${w}`);const F=await y.send(),S=s(F.headers);if(![200,303].includes(F.status))throw new Error("Failed to login: Server respond with "+F.status);if(303===F.status&&F.headers.get("location")?.includes("8"))throw new Error("Failed to login: Connection refused.");if(303===F.status&&!F.headers.get("location"))throw new Error("Failed to login: No location header found.");if(303===F.status&&!S.find(e=>e.startsWith(`${o}=`)))throw new Error("Failed to login: No session cookie found.");if(303===F.status&&F.headers.get("location")?.includes("2"))throw new Error("Failed to login: Invalid credentials.");if(303===F.status&&F.headers.get("location")?.includes("4"))throw new Error("Failed to login: Account locked or not activated.");const E={id:S.find(e=>e.startsWith(`${o}=`)).split("=")[1].split(";")[0],baseURL:`${t}${p?p.split(".")[1]+".php":""}`,serverId:w.split("=")[1],cookieName:h.split("=")[0]};return console.log("sess",E),E},d=async(e,t,r)=>{const n=new i(e,"/"),s=await n.send(),o=await s.text();if(302!==s.status){if(!a.check_instance_netypareo.test(o))throw new Error("Failed to verify instance. Not a valid NetYPareo instance");if(!a.check_instance_ymag.test(o))throw new Error("Failed to verify instance. Not a valid NetYPareo instance")}const d=s.headers.get("location")||"",c={id:t,baseURL:`${e}${d?d.split(".")[1]+".php":""}`,serverId:r,cookieName:"NYSESSID"},l=new i(c.baseURL,"/apprenant/accueil");l.setSession(c);const p=await l.send();if(200!==p.status)throw new Error("Failed to login: Server respond with "+p.status);return c},c=e=>({web_class:e.classe,text:e.libelle}),l=e=>{let t=e.couleur;if(t.startsWith("rgba")){const r=e.color.slice(5,-1).split(", "),n=parseInt(r[0]),i=parseInt(r[1]),a=parseInt(r[2]),s=parseInt(r[3]);t=`#${n.toString(16)}${i.toString(16)}${a.toString(16)}${s.toString(16)}`}const r=e.minuteDebut,n=Math.floor(r/60),i=new Date(0,0,0,n,r%60),a=e.minuteDebut+e.duree,s=Math.floor(a/60),o=new Date(0,0,0,s,a%60),d=e.icones.map(c);return{id:e.code,type:e.type,name:e.libelle,duration:e.duree,details:e.detail,subject_id:e.metadatas.codeMatiere,subject_coefficient:e.metadatas.coeff,subject_groups:e.metadatas.codesGroupes,color:t,start:i,end:o,icon:d}},p=async(e,t)=>{if(!e.id)throw new Error("Session cookie is not defined ! You must login first.");if(!e.baseURL)throw new Error("Base URL is not defined ! You must login first.");const r=t.toISOString().split("T")[0].split("-").reverse().join("/"),n=new i(e.baseURL,`/planning/jour/ajax/${r}`);n.setSession(e);const a=await n.send();if(200!==a.status)throw new Error("Failed to fetch planning: The session has expired");try{const e=await a.text(),t=JSON.parse(e);return{day_start_in_minutes:(s=t).configuration.minuteDebut,day_end_in_minutes:s.configuration.minuteFin,day_number:s.configuration.jours[0],week_id:s.semaines[0].code,week_start:new Date(s.semaines[0].dateDebut),week_text:s.semaines[0].libelle,slots:s.semaines[0].ressources[0].seances.map(l)}}catch(e){throw new Error(`Failed to parse the planning: ${e}`)}var s},m=async(e,t,r)=>{if(!e.id)throw new Error("Session cookie is not defined ! You must login first.");if(!e.baseURL)throw new Error("Base URL is not defined ! You must login first.");const n=new i(e.baseURL,`/apprenant/planning/courant/?semaineDebut=${t}${r}`);n.setSession(e);const s=await n.send();if(200!==s.status)throw new Error("Failed to fetch timetable: The session has expired");try{const e=(await s.text()).match(a.student_timetable);if(!e)throw new Error("Failed to get student timetable");const t=JSON.parse(e[1]);return console.log("planning",t),{week_id:(o=t).semaines[0].code,week_start:new Date(o.semaines[0].dateDebut),week_text:o.semaines[0].libelle,slots:o.semaines[0].ressources[0].seances.map(l)}}catch(e){throw new Error(`Failed to parse the planning: ${e}`)}var o},u=t=>{const r=[];return t.find("tr").each((t,n)=>{const i=(e=>{const t=e("td > span"),r=e("td.coeff"),n=e("td.moyenne-grp"),i=e("td.moyenne-mini-grp"),a=e("td.moyenne-maxi-grp"),s=e("td.moyenneApp"),o=e("td.cell-appreciation"),d=t.text().trim(),c=parseFloat(r.text().replace(",",".")),l=""==n.text().trim()?void 0:parseFloat(n.text().replace(",",".")),p=""==i.text().trim()?void 0:parseFloat(i.text().replace(",",".")),m=""==a.text().trim()?void 0:parseFloat(a.text().replace(",",".")),u=""==s.text().trim()?void 0:parseFloat(s.text().replace(",",".")),f=""==o.text().trim()?void 0:o.text().trim(),h=parseInt(o.attr("data-code_inscription")??"-1"),w=parseInt(o.attr("data-code_apprenant")??"-1");return{subject_id:parseInt(o.attr("data-code_matiere")??"-1"),subject_name:d,coefficient:c,group_average:l,group_average_min:p,group_average_max:m,average:u,teacher_comment:f,registration_id:h,student_id:w}})(e.load(n));r.push(i)}),r},f=(e,t)=>{let r={};return t.forEach(t=>{r[t.session_id]=((e,t)=>{const r=e(`div[id="bulletin_${t.session_id}"]`).find("table"),n=r.find("tbody"),i=r.find("tfoot"),a=u(e(n)),s=i.find("td.moyenne-grp"),o=i.find("td.moyenne-mini-grp"),d=i.find("td.moyenne-maxi-grp"),c=i.find("td.moyenneApp"),l=i.find("td.cell-appreciation");return{subject_list:a,group_average:""==s.text().trim()?void 0:parseFloat(s.text().replace(",",".")),group_average_min:""==o.text().trim()?void 0:parseFloat(o.text().replace(",",".")),group_average_max:""==d.text().trim()?void 0:parseFloat(d.text().replace(",",".")),average:""==c.text().trim()?void 0:parseFloat(c.text().replace(",",".")),teacher_comment:""==l.text().trim()?void 0:l.text().trim(),registration_id:parseInt(l.attr("data-code_inscription")??"-1"),student_id:parseInt(l.attr("data-code_apprenant")??"-1")}})(e,t)}),r},h=e=>{const t=(e=>{const t=e("select[id='bulletin-filtre-periode']");if(0===t.length)return[];const r=t.find("option");if(0===r.length)return[];const n=[];return r.each((t,r)=>{const i=parseInt(e(r).attr("value")??"-1"),a=parseInt(e(r).attr("data-code-session")??"-1"),s=e(r).text();n.push({session_id:i,session_code:a,name:s})}),n})(e);return{session_list:t,session:f(e,t)}},w=t=>{const r=t('table[id^="tableau-note-"] > tbody');if(0===r.length)return[];const n=r.find("tr");if(0===n.length)return[];const i=[];return n.each((t,r)=>{const n=(e=>{const t=e("td").first(),r=t.find("span"),n=e("td").eq(1),i=e("td").eq(2),a=e("td").eq(3),s=e("td").eq(4),o=r.text().trim(),d=r.attr("data-tooltip-content")??"",c=new Date(t.text().trim().slice(-10)),l=n.text().trim(),p=i.text().trim(),m=parseFloat(a.text().replace(",",".")),u=parseFloat(s.text().trim().replace(",","."))||void 0,f=!/^\d+\.\d+$/.test(s.text().trim().replace(",","."));return{teacher_name:d,teacher_initials:o,grade_type:l,date:c,name:p,coefficient:m,grade:u,absent:f,absence_reason:f?s.text().trim():void 0}})(e.load(r));i.push(n)}),i},g=async t=>{if(!t.id)throw new Error("Session cookie is not defined ! You must login first.");if(!t.baseURL)throw new Error("Base URL is not defined ! You must login first.");const r=new i(t.baseURL,"/apprenant/bulletin");r.setSession(t);const n=await r.send();if(200!==n.status)throw new Error("Failed to fetch report: The session has expired");const a=await n.text(),s=e.load(a);return h(s)},x=async(t,r,n)=>{if(!t.id||!t.baseURL)throw new Error("Session is not valid ! You must login first.");const a=new i(t.baseURL,`/apprenant/detail-notes/${r.registration_id}/${r.subject_id}/${n}`);a.setSession(t);const s=await a.send();if(200!==s.status)throw new Error("Failed to fetch subject details: The session has expired");const o=await s.text();return(e=>{const t=e('td.table-cell.text-bold:contains("Moyenne de l\'apprenant")').next(),r=e('td.table-cell.text-bold:contains("Moyenne du groupe")').next(),n=e('td.table-cell.text-bold:contains("Moyenne minimale")').next(),i=e('td.table-cell.text-bold:contains("Moyenne maximale")').next(),a=e('div.section-title:contains("Appréciation")').next(),s=e("div.modal-tabs-description"),o=s.text().trim().split("\n")[0],d=parseFloat(s.text().trim().split("\n")[1].replace("- coef. ","").trim().replace(",",".")),c=w(e),l="-"==t.text().trim()?void 0:parseFloat(t.text().replace(",","."));return{subject_name:o,subject_coefficient:d,grades:c,group_average:"-"==r.text().trim()?void 0:parseFloat(r.text().replace(",",".")),group_average_min:"-"==n.text().trim()?void 0:parseFloat(n.text().replace(",",".")),group_average_max:"-"==i.text().trim()?void 0:parseFloat(i.text().replace(",",".")),average:l,teacher_comment:a.text().trim().includes("Les appréciations ne sont pas consultables pour cette période.")?void 0:a.text().trim()}})(e.load(o))},_=e=>{const i=e(".block-toolbar .ellipsis").first().text().trim(),a=i.replace(/^(M\.|Mme)\s*/i,"").trim(),[s,...o]=a.split(/\s+/),d=o.join(" "),c=`${d} ${s}`.trim(),l=i.includes("Mme")?"F":i.includes("M.")?"M":"O",p=e("div[id^='card-adresse']").first(),m=p.find(".block-adresse-ligne:contains('Adresse')").clone().children("span").remove().end().text().split("\n").map(e=>e.trim()).filter(e=>e&&"-"!==e&&!/\d{5}\s+\S+/.test(e)&&!/^[A-Z\s\-]{2,}$/.test(e)).join(", "),u=p.find(".block-body").text().split("\n").map(e=>e.trim()).filter(Boolean),f=u.find(e=>/\d{5}\s+\S+/.test(e))||"",h=f.match(/\d{5}/)?.[0]??"",w=f.replace(h,"").trim(),g=u.find(e=>/^[A-Z\s\-]{2,}$/.test(e))||"France",x=p.find("a[href^='tel:']").first().text().replace(/[\s.]/g,"").trim(),_=p.find("a[href^='/cdn-cgi/l/email-protection'], a[href^='mailto:']").first(),b=_.attr("href"),v=b?.startsWith("/cdn-cgi/")?(e=>{const t=e.startsWith("#")?e.slice(1):e;let r="";const n=parseInt(t.slice(0,2),16);for(let e=2;e<t.length;e+=2){const i=parseInt(t.slice(e,e+2),16)^n;r+=String.fromCharCode(i)}return r})(b.split("#")[1]||""):_.text().trim(),y=e("p:contains('Né')").text(),F=y.match(/le (\d{1,2} \w+ \d{4})/)?.[1]||"",S=t(F,"d MMMM yyyy",new Date,{locale:n}),E=e(".modal-link-formation").first().text().trim(),k=e(".lnk-modal-groupe").first().text().trim(),$=e(".user-info-label span").first().text().trim().match(/(\d{4}-\d{4})/),R=$?$[1]:null;return{firstName:d,lastName:s,fullName:c,email:v,phone:x,address:m,postalCode:h,city:w,country:g,gender:l,dateOfBirth:r(S,"yyyy-MM-dd"),className:E,groupName:k,currentSchoolCycle:R}},b=async t=>{if(!t.id)throw new Error("Session cookie is not defined ! You must login first.");if(!t.baseURL)throw new Error("Base URL is not defined ! You must login first.");const r=new i(t.baseURL,"/apprenant/details");r.setSession(t),console.log("reqqq",r);const n=await r.send();if(console.log("status",n.status),200!==n.status)throw new Error("Failed to fetch profile: The session has expired");const a=await n.arrayBuffer(),s=Buffer.from(a).toString("latin1");try{const t=e.load(s);return _(t)}catch(e){throw new Error(`Failed to parse the profile: ${e}`)}};export{b as getProfile,d as loginCookie,o as loginCredentials,p as planningFromDay,m as planningFromWeek,g as report,x as reportSubjectDetails};//# sourceMappingURL=index.mjs.map